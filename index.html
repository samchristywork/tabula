<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #eee;
      }
      .table-container {
        position: absolute;
        z-index: 1;
      }
      .drag-bar {
        background-color: #d3d3d3;
        padding: 4px;
        cursor: move;
        font-size: 0.75rem;
        text-align: center;
        border-radius: 0.25rem 0.25rem 0 0;
        border: 1px solid black;
        border-bottom: none;
        position: relative;
      }
      .drag-bar img {
        height: 0.75rem;
        position: absolute;
        right: 0.5rem;
      }
      .button-container button {
        border: none;
      }
      .button-container button img {
        height: 0.9rem;
      }
      table {
        border-collapse: collapse;
        background-color: white;
        min-width: 100%;
      }
      th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <script>
      const tables = [
        {
          name: "Test Table 1",
          position: {x: 10, y: 10},
          heading: ["Column 1", "Column 2", "Column 3"],
          content: [
            ["'foo'", "'bar'", "'baz'"],
            ["'apple'", "'banana'", "'carrot'"]
          ]
        },
      ];

      function createTableElement(table, tableIndex) {
        const container = document.createElement('div');
        container.className = 'table-container';
        container.style.left = table.position.x + 'px';
        container.style.top = table.position.y + 'px';

        container.addEventListener('mousedown', (event) => {
          event.stopPropagation();
          setActiveTable(container);
        });

        const dragBar = document.createElement('div');
        dragBar.className = 'drag-bar';
        const titleText = document.createTextNode(table.name);
        dragBar.appendChild(titleText);

        const img = document.createElement('img');
        img.src = "edit.svg";
        img.onclick = () => {
          const newTitle = prompt("Enter new table title:", table.name);
          if (newTitle !== null) {
            table.name = newTitle;
            dragBar.replaceChild(document.createTextNode(newTitle), titleText);
          }
        };
        dragBar.appendChild(img);
        container.appendChild(dragBar);

        const tableElement = document.createElement('table');

        const headerRow = document.createElement('tr');
        table.heading.forEach((headingText, headingIndex) => {
          const th = document.createElement('th');
          th.contentEditable = true;
          th.textContent = headingText;
          th.addEventListener('blur', () => {
            table.heading[headingIndex] = th.textContent;
          });
          headerRow.appendChild(th);
        });
        tableElement.appendChild(headerRow);

        table.content.forEach((rowData, rowIndex) => {
          const row = document.createElement('tr');
          rowData.forEach((cellData, cellIndex) => {
            const td = document.createElement('td');
            try {
              td.textContent = eval(cellData);
            } catch {
              td.textContent = 'Error';
            }

            td.onclick = () => {
              const newValue = prompt("Edit Cell:", cellData);
              if (newValue !== null) {
                table.content[rowIndex][cellIndex] = newValue;
                render();
              }
            };

            row.appendChild(td);
          });
          tableElement.appendChild(row);
        });

        container.appendChild(tableElement);
        makeDraggable(container, dragBar, tableIndex);

        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'button-container';

        const addRowButton = document.createElement('button');
        addRowButton.innerHTML = `<img src='add-row.svg'></img>`;
        addRowButton.onclick = () => {
          const newRow = new Array(table.heading.length).fill("");
          table.content.push(newRow);
          render();
        };
        buttonContainer.appendChild(addRowButton);

        const addColumnButton = document.createElement('button');
        addColumnButton.textContent = 'Add Column';
        addColumnButton.innerHTML = `<img src='add-column.svg'></img>`;
        addColumnButton.onclick = () => {
          let newColName = 'Column ' + String.fromCharCode(65 + table.heading.length);
          newColName = prompt("Enter new column title:", newColName);
          table.heading.push(newColName);
          table.content.forEach(row => row.push(""));
          render();
        };
        buttonContainer.appendChild(addColumnButton);
        container.appendChild(buttonContainer);

        return container;
      }

      function makeDraggable(element, handle, index) {
        let offsetX = 0, offsetY = 0;

        handle.onmousedown = function(e) {
          e.preventDefault();
          offsetX = e.clientX - element.offsetLeft;
          offsetY = e.clientY - element.offsetTop;
          document.onmousemove = onMouseMove;
          document.onmouseup = onMouseUp;
        };

        function onMouseMove(e) {
          e.preventDefault();
          element.style.left = e.clientX - offsetX + "px";
          element.style.top = e.clientY - offsetY + "px";
        }

        function onMouseUp() {
          document.onmousemove = null;
          document.onmouseup = null;
          tables[index].position.x = parseInt(element.style.left, 10);
          tables[index].position.y = parseInt(element.style.top, 10);
        }
      }

      function setActiveTable(activeTable) {
        document.querySelectorAll('.table-container').forEach((container) => {
          container.style.zIndex = container === activeTable ? 999 : 1;
        });
      }

      function render() {
        document.body.innerHTML = '';
        tables.forEach((table, index) => {
          const tableElement = createTableElement(table, index);
          document.body.appendChild(tableElement);
        });
      }

      render();
    </script>
  </body>
</html>
